#!/usr/bin/env bash
# pipe-load-prompt - Interactive prompt for loading command output into buffer
#
# Usage: pipe-load-prompt <output_file> <cmd_file>
#
# Arguments:
#   output_file - File where command output will be written
#   cmd_file    - File where the executed command will be recorded
#
# Features:
#   - Full readline support (history, Ctrl+R, tab completion, env vars)
#   - Command is written to cmd_file for the calling process
#   - Exit status matches the executed command's exit status

set -o pipefail

if [[ $# -ne 2 ]]; then
    echo "Usage: pipe-load-prompt <output_file> <cmd_file>" >&2
    exit 1
fi

output_file="$1"
cmd_file="$2"

# Enable vi line editing mode
set -o vi

# Prompt for command with readline support
# -e enables readline editing
# -p sets the prompt
if ! read -e -p "load> " cmd; then
    # User pressed Ctrl+C or Ctrl+D
    exit 130
fi

# Handle empty command
if [[ -z "$cmd" ]]; then
    exit 0
fi

# Write command to cmd_file
echo "$cmd" > "$cmd_file"

# Execute command and capture output
eval "$cmd" > "$output_file"
exit_status=$?

exit $exit_status
